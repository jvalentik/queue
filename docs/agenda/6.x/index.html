<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@mwp/agenda</title><meta name="description" content="Documentation for @mwp/agenda"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@mwp/agenda</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h2>@mwp/agenda</h2></div><div class="tsd-panel tsd-typography"><p><strong>DISCLAIMER</strong>: I <strong>do not</strong> intend to actively maintain this repository.
I forked it from <a href="https://github.com/hokify/agenda">https://github.com/hokify/agenda</a> because I desperately needed support for <a href="https://www.npmjs.com/package/mongodb">mongodb@6</a> for my website <a href="http://www.whisthub.com">www.whisthub.com</a>.
Ideally this gets merged back eventually into <a href="https://github.com/hokify/agenda">@hokify/agenda</a>, or even better in <a href="https://github.com/agenda/agenda">agenda/agenda</a>.</p>
<p>However, I <em>do</em> intend to keep this up to date with the latest version of the <a href="https://www.npmjs.com/package/mongodb">mongodb</a> package, but that&#39;s all.
Agenda is a great library and I would hate to see it dying because new mongodb versions are not supported.</p>
<p>Key differences with the <a href="https://github.com/hokify/agenda">original repo</a> are: </p>
<ul>
<li>MongoDB is now a peer dependency, so it must be installed separately.</li>
<li>The module is now <a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c">esm only</a>. This is to prepare for any of the dependencies - most notably <code>mongodb</code> - becoming esm-only one day too. It also helps push the ecosystem forward.</li>
<li>The library is only tested against <code>mongodb@6</code>, but it should work for version 5 and even 4.</li>
</ul>
<a id="md:agenda" class="tsd-anchor"></a><h1><a href="#md:agenda">Agenda</a></h1><p align="center">
  <img src="https://cdn.jsdelivr.net/gh/hokify/agenda@master/agendats.png" alt="Agenda TS" width="100" height="100">
</p>
<p align="center">
  A light-weight job scheduling library for Node.js
</p>

<p>This was originally a fork of agenda.js,
it differs from the original version in following points:</p>
<ul>
<li>Complete rewrite in Typescript (fully typed!)</li>
<li><a href="https://www.npmjs.com/package/mongodb">mongodb@6</a> driver (supports mongodb 5.x and mongodb 4.x too)</li>
<li>Supports mongoDB sharding by name</li>
<li>touch() can have an optional progress parameter (0-100)</li>
<li>Bugfixes and improvements for locking &amp; job processing (concurrency, lockLimit,..)</li>
<li>Breaking change: define() config paramter moved from 2nd position to 3rd</li>
<li>getRunningStats()</li>
<li>automatically waits for agenda to be connected before calling any database operations</li>
<li>uses a database abstraction layer behind the scene</li>
<li>does not create a database index by default, you can set <code>ensureIndex: true</code> when initializing Agenda
or run manually:</li>
</ul>
<pre><code><span class="hl-0">db</span><span class="hl-1">.</span><span class="hl-0">agendaJobs</span><span class="hl-1">.</span><span class="hl-2">ensureIndex</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;name&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;nextRunAt&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;priority&quot;</span><span class="hl-0"> :</span><span class="hl-1"> -</span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;lockedAt&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;disabled&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><br/><span class="hl-1">}, </span><span class="hl-3">&quot;findAndLockNextJobIndex&quot;</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>
<a id="md:agenda-offers" class="tsd-anchor"></a><h1><a href="#md:agenda-offers">Agenda offers</a></h1><ul>
<li>Minimal overhead. Agenda aims to keep its code base small.</li>
<li>Mongo backed persistence layer.</li>
<li>Promises based API.</li>
<li>Scheduling with configurable priority, concurrency, and repeating.</li>
<li>Scheduling via cron or human readable syntax.</li>
<li>Event backed job queue that you can hook into.</li>
<li><a href="https://github.com/agenda/agendash">Agendash</a>: optional standalone web-interface.</li>
<li><a href="https://github.com/agenda/agenda-rest">Agenda-rest</a>: optional standalone REST API.</li>
<li><a href="https://github.com/lautarobock/inversify-agenda">inversify-agenda</a> - Some utilities for the development of agenda workers with Inversify</li>
</ul>
<a id="md:feature-comparison" class="tsd-anchor"></a><h3><a href="#md:feature-comparison">Feature Comparison</a></h3><p>Since there are a few job queue solutions, here a table comparing them to help you use the one that
better suits your needs.</p>
<table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="center">Bull</th>
<th align="center">Bee</th>
<th align="center">Agenda</th>
<th align="center">AgendaTS</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Backend</td>
<td align="center">redis</td>
<td align="center">redis</td>
<td align="center">mongo</td>
<td align="center">mongo</td>
</tr>
<tr>
<td align="left">Priorities</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Concurrency</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Delayed jobs</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Global events</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Rate Limiter</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="left">Pause/Resume</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Sandboxed worker</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Repeatable jobs</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Atomic ops</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center">~</td>
</tr>
<tr>
<td align="left">Persistence</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">UI</td>
<td align="center">✓</td>
<td align="center"></td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">REST API</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Central (Scalable) Queue</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Supports long running jobs</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Optimized for</td>
<td align="center">Jobs / Messages</td>
<td align="center">Messages</td>
<td align="center">Jobs</td>
<td align="center">Jobs</td>
</tr>
</tbody></table>
<p><em>Kudos for making the comparison chart goes to <a href="https://www.npmjs.com/package/bull#feature-comparison">Bull</a> maintainers.</em></p>
<a id="md:installation" class="tsd-anchor"></a><h1><a href="#md:installation">Installation</a></h1><p>Install via NPM</p>
<pre><code><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-0">install</span><span class="hl-1"> @</span><span class="hl-0">hokify</span><span class="hl-1">/</span><span class="hl-0">agenda</span>
</code><button>Copy</button></pre>
<p>You will also need a working <a href="https://www.mongodb.com/">Mongo</a> database (v4+) to point it to.</p>
<a id="md:example-usage" class="tsd-anchor"></a><h1><a href="#md:example-usage">Example Usage</a></h1><pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">mongoConnectionString</span><span class="hl-1"> = </span><span class="hl-3">&#39;mongodb://127.0.0.1/agenda&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">db:</span><span class="hl-1"> { </span><span class="hl-0">address:</span><span class="hl-1"> </span><span class="hl-0">mongoConnectionString</span><span class="hl-1"> } });</span><br/><br/><span class="hl-7">// Or override the default collection name:</span><br/><span class="hl-7">// const agenda = new Agenda({db: {address: mongoConnectionString, collection: &#39;jobCollectionName&#39;}});</span><br/><br/><span class="hl-7">// or pass additional connection options:</span><br/><span class="hl-7">// const agenda = new Agenda({db: {address: mongoConnectionString, collection: &#39;jobCollectionName&#39;, options: {ssl: true}}});</span><br/><br/><span class="hl-7">// or pass in an existing mongodb-native MongoClient instance</span><br/><span class="hl-7">// const agenda = new Agenda({mongo: myMongoClient});</span><br/><br/><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;delete old users&#39;</span><span class="hl-1">, </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">User</span><span class="hl-1">.</span><span class="hl-2">remove</span><span class="hl-1">({ </span><span class="hl-0">lastLogIn:</span><span class="hl-1"> { </span><span class="hl-0">$lt:</span><span class="hl-1"> </span><span class="hl-0">twoDaysAgo</span><span class="hl-1"> } });</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-1">(</span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-5">function</span><span class="hl-1"> () {</span><br/><span class="hl-1">    </span><span class="hl-7">// IIFE to give access to async/await</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">();</span><br/><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">every</span><span class="hl-1">(</span><span class="hl-3">&#39;3 minutes&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;delete old users&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-7">// Alternatively, you could also do:</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">every</span><span class="hl-1">(</span><span class="hl-3">&#39;*/3 * * * *&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;delete old users&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">})();</span>
</code><button>Copy</button></pre>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-3">&#39;send email report&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">const</span><span class="hl-1"> { </span><span class="hl-6">to</span><span class="hl-1"> } = </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-0">attrs</span><span class="hl-1">.</span><span class="hl-0">data</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">emailClient</span><span class="hl-1">.</span><span class="hl-2">send</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-0">to</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-0">from:</span><span class="hl-1"> </span><span class="hl-3">&#39;example@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-0">subject:</span><span class="hl-1"> </span><span class="hl-3">&#39;Email Report&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-0">body:</span><span class="hl-1"> </span><span class="hl-3">&#39;...&#39;</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    { </span><span class="hl-0">priority:</span><span class="hl-1"> </span><span class="hl-3">&#39;high&#39;</span><span class="hl-1">, </span><span class="hl-0">concurrency:</span><span class="hl-1"> </span><span class="hl-4">10</span><span class="hl-1"> }</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-1">(</span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-5">function</span><span class="hl-1"> () {</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">schedule</span><span class="hl-1">(</span><span class="hl-3">&#39;in 20 minutes&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;send email report&#39;</span><span class="hl-1">, { </span><span class="hl-0">to:</span><span class="hl-1"> </span><span class="hl-3">&#39;admin@example.com&#39;</span><span class="hl-1"> });</span><br/><span class="hl-1">})();</span>
</code><button>Copy</button></pre>
<pre><code class="language-js"><span class="hl-1">(</span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-5">function</span><span class="hl-1"> () {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">weeklyReport</span><span class="hl-1"> = </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">create</span><span class="hl-1">(</span><span class="hl-3">&#39;send email report&#39;</span><span class="hl-1">, { </span><span class="hl-0">to:</span><span class="hl-1"> </span><span class="hl-3">&#39;example@example.com&#39;</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">weeklyReport</span><span class="hl-1">.</span><span class="hl-2">repeatEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;1 week&#39;</span><span class="hl-1">).</span><span class="hl-2">save</span><span class="hl-1">();</span><br/><span class="hl-1">})();</span>
</code><button>Copy</button></pre>
<a id="md:full-documentation" class="tsd-anchor"></a><h1><a href="#md:full-documentation">Full documentation</a></h1><p>See also <a href="https://hokify.github.io/agenda/">https://hokify.github.io/agenda/</a></p>
<p>Agenda&#39;s basic control structure is an instance of an agenda. Agenda&#39;s are
mapped to a database collection and load the jobs from within.</p>
<a id="md:table-of-contents" class="tsd-anchor"></a><h2><a href="#md:table-of-contents">Table of Contents</a></h2><ul>
<li><a href="#md:configuring-an-agenda">Configuring an agenda</a></li>
<li><a href="#md:agenda-events">Agenda Events</a></li>
<li><a href="#md:defining-job-processors">Defining job processors</a></li>
<li><a href="#md:creating-jobs">Creating jobs</a></li>
<li><a href="#md:managing-jobs">Managing jobs</a></li>
<li><a href="#md:starting-the-job-processor">Starting the job processor</a></li>
<li><a href="#md:multiple-job-processors">Multiple job processors</a></li>
<li><a href="#md:manually-working-with-a-job">Manually working with jobs</a></li>
<li><a href="#md:job-queue-events">Job Queue Events</a></li>
<li><a href="#md:frequently-asked-questions">Frequently asked questions</a></li>
<li><a href="#md:example-project-structure">Example Project structure</a></li>
<li><a href="#md:known-issues">Known Issues</a></li>
<li><a href="#md:debugging-issues">Debugging Issues</a></li>
<li><a href="#md:acknowledgements">Acknowledgements</a></li>
</ul>
<a id="md:configuring-an-agenda" class="tsd-anchor"></a><h2><a href="#md:configuring-an-agenda">Configuring an agenda</a></h2><p>All configuration methods are chainable, meaning you can do something like:</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">();</span><br/><span class="hl-0">agenda</span><br/><span class="hl-1">  .</span><span class="hl-2">database</span><span class="hl-1">(...)</span><br/><span class="hl-1">  .</span><span class="hl-2">processEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;3 minutes&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  ...;</span>
</code><button>Copy</button></pre>
<p>Possible agenda config options:</p>
<pre><code class="language-ts"><span class="hl-1">{</span><br/><span class="hl-1">    </span><span class="hl-9">name</span><span class="hl-1">: </span><span class="hl-0">string</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">defaultConcurrency</span><span class="hl-1">: </span><span class="hl-0">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">processEvery</span><span class="hl-1">: </span><span class="hl-0">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">maxConcurrency</span><span class="hl-1">: </span><span class="hl-0">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">defaultLockLimit</span><span class="hl-1">: </span><span class="hl-0">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">lockLimit</span><span class="hl-1">: </span><span class="hl-0">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">defaultLockLifetime</span><span class="hl-1">: </span><span class="hl-0">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">ensureIndex</span><span class="hl-1">: </span><span class="hl-0">boolean</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-9">sort</span><span class="hl-1">: </span><span class="hl-0">SortOptionObject</span><span class="hl-1">&lt;</span><span class="hl-0">IJobParameters</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">    </span><span class="hl-9">db</span><span class="hl-1">: {</span><br/><span class="hl-1">        </span><span class="hl-9">collection</span><span class="hl-1">: </span><span class="hl-0">string</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-9">address</span><span class="hl-1">: </span><span class="hl-0">string</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-9">options</span><span class="hl-1">: </span><span class="hl-0">MongoClientOptions</span><span class="hl-1">;</span><br/><span class="hl-1">    };</span><br/><span class="hl-1">    </span><span class="hl-9">mongo</span><span class="hl-1">: </span><span class="hl-0">Db</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>Agenda uses <a href="http://github.com/rschmukler/human-interval">Human Interval</a> for specifying the intervals. It supports the following units:</p>
<p><code>seconds</code>, <code>minutes</code>, <code>hours</code>, <code>days</code>,<code>weeks</code>, <code>months</code> -- assumes 30 days, <code>years</code> -- assumes 365 days</p>
<p>More sophisticated examples</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">processEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;one minute&#39;</span><span class="hl-1">);</span><br/><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">processEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;1.5 minutes&#39;</span><span class="hl-1">);</span><br/><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">processEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;3 days and 4 hours&#39;</span><span class="hl-1">);</span><br/><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">processEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;3 days, 4 hours and 36 seconds&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<a id="md:databaseurl-collectionname-mongoclientoptions" class="tsd-anchor"></a><h3><a href="#md:databaseurl-collectionname-mongoclientoptions">database(url, [collectionName], [MongoClientOptions])</a></h3><p>Specifies the database at the <code>url</code> specified. If no collection name is given,
<code>agendaJobs</code> is used.</p>
<p>By default <code>useNewUrlParser</code> and <code>useUnifiedTopology</code> is set to <code>true</code>,</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">database</span><span class="hl-1">(</span><span class="hl-3">&#39;localhost:27017/agenda-test&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;agendaJobs&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation.</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-0">db:</span><span class="hl-1"> { </span><span class="hl-0">address:</span><span class="hl-1"> </span><span class="hl-3">&#39;localhost:27017/agenda-test&#39;</span><span class="hl-1">, </span><span class="hl-0">collection:</span><span class="hl-1"> </span><span class="hl-3">&#39;agendaJobs&#39;</span><span class="hl-1"> }</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<p>Agenda will emit a <code>ready</code> event (see <a href="#md:agenda-events">Agenda Events</a>) when properly connected to the database.
It is safe to call <code>agenda.start()</code> without waiting for this event, as this is handled internally.
If you&#39;re using the <code>db</code> options, or call <code>database</code>, then you may still need to listen for <code>ready</code> before saving jobs.</p>
<a id="md:mongodbinstance-collectionname" class="tsd-anchor"></a><h3><a href="#md:mongodbinstance-collectionname">mongo(dbInstance, [collectionName])</a></h3><p>Use an existing mongodb-native MongoClient/Db instance. This can help consolidate connections to a
database. You can instead use <code>.database</code> to have agenda handle connecting for you.</p>
<p>You can also specify it during instantiation:</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">mongo:</span><span class="hl-1"> </span><span class="hl-0">mongoClientInstance</span><span class="hl-1">.</span><span class="hl-2">db</span><span class="hl-1">(</span><span class="hl-3">&#39;agenda-test&#39;</span><span class="hl-1">) });</span>
</code><button>Copy</button></pre>
<p>Note that MongoClient.connect() returns a mongoClientInstance since <a href="https://github.com/mongodb/node-mongodb-native/blob/master/CHANGES_3.0.0.md">node-mongodb-native 3.0.0</a>, while it used to return a dbInstance that could then be directly passed to agenda.</p>
<a id="md:namename" class="tsd-anchor"></a><h3><a href="#md:namename">name(name)</a></h3><p>Takes a string <code>name</code> and sets <code>lastModifiedBy</code> to it in the job database.
Useful for if you have multiple job processors (agendas) and want to see which
job queue last ran the job.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">name</span><span class="hl-1">(</span><span class="hl-0">os</span><span class="hl-1">.</span><span class="hl-0">hostname</span><span class="hl-1"> + </span><span class="hl-3">&#39;-&#39;</span><span class="hl-1"> + </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">pid</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">name:</span><span class="hl-1"> </span><span class="hl-3">&#39;test queue&#39;</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:processeveryinterval" class="tsd-anchor"></a><h3><a href="#md:processeveryinterval">processEvery(interval)</a></h3><p>Takes a string <code>interval</code> which can be either a traditional javascript number,
or a string such as <code>3 minutes</code></p>
<p>Specifies the frequency at which agenda will query the database looking for jobs
that need to be processed. Agenda internally uses <code>setTimeout</code> to guarantee that
jobs run at (close to ~3ms) the right time.</p>
<p>Decreasing the frequency will result in fewer database queries, but more jobs
being stored in memory.</p>
<p>Also worth noting is that if the job queue is shutdown, any jobs stored in memory
that haven&#39;t run will still be locked, meaning that you may have to wait for the
lock to expire. By default it is <code>&#39;5 seconds&#39;</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">processEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;1 minute&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">processEvery:</span><span class="hl-1"> </span><span class="hl-3">&#39;30 seconds&#39;</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:maxconcurrencynumber" class="tsd-anchor"></a><h3><a href="#md:maxconcurrencynumber">maxConcurrency(number)</a></h3><p>Takes a <code>number</code> which specifies the max number of jobs that can be running at
any given moment. By default it is <code>20</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">maxConcurrency</span><span class="hl-1">(</span><span class="hl-4">20</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">maxConcurrency:</span><span class="hl-1"> </span><span class="hl-4">20</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:defaultconcurrencynumber" class="tsd-anchor"></a><h3><a href="#md:defaultconcurrencynumber">defaultConcurrency(number)</a></h3><p>Takes a <code>number</code> which specifies the default number of a specific job that can be running at
any given moment. By default it is <code>5</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">defaultConcurrency</span><span class="hl-1">(</span><span class="hl-4">5</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">defaultConcurrency:</span><span class="hl-1"> </span><span class="hl-4">5</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:locklimitnumber" class="tsd-anchor"></a><h3><a href="#md:locklimitnumber">lockLimit(number)</a></h3><p>Takes a <code>number</code> which specifies the max number jobs that can be locked at any given moment. By default it is <code>0</code> for no max.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">lockLimit</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">lockLimit:</span><span class="hl-1"> </span><span class="hl-4">0</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:defaultlocklimitnumber" class="tsd-anchor"></a><h3><a href="#md:defaultlocklimitnumber">defaultLockLimit(number)</a></h3><p>Takes a <code>number</code> which specifies the default number of a specific job that can be locked at any given moment. By default it is <code>0</code> for no max.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">defaultLockLimit</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">defaultLockLimit:</span><span class="hl-1"> </span><span class="hl-4">0</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:defaultlocklifetimenumber" class="tsd-anchor"></a><h3><a href="#md:defaultlocklifetimenumber">defaultLockLifetime(number)</a></h3><p>Takes a <code>number</code> which specifies the default lock lifetime in milliseconds. By
default it is 10 minutes. This can be overridden by specifying the
<code>lockLifetime</code> option to a defined job.</p>
<p>A job will unlock if it is finished (ie. the returned Promise resolves/rejects
or <code>done</code> is specified in the params and <code>done()</code> is called) before the
<code>lockLifetime</code>. The lock is useful if the job crashes or times out.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">defaultLockLifetime</span><span class="hl-1">(</span><span class="hl-4">10000</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>You can also specify it during instantiation</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">defaultLockLifetime:</span><span class="hl-1"> </span><span class="hl-4">10000</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<a id="md:sortquery" class="tsd-anchor"></a><h3><a href="#md:sortquery">sort(query)</a></h3><p>Takes a <code>query</code> which specifies the sort query to be used for finding and locking the next job.</p>
<p>By default it is <code>{ nextRunAt: 1, priority: -1 }</code>, which obeys a first in first out approach, with respect to priority.</p>
<a id="md:agenda-events" class="tsd-anchor"></a><h2><a href="#md:agenda-events">Agenda Events</a></h2><p>An instance of an agenda will emit the following events:</p>
<ul>
<li><code>ready</code> - called when Agenda mongo connection is successfully opened and indices created.
If you&#39;re passing agenda an existing connection, you shouldn&#39;t need to listen for this, as <code>agenda.start()</code> will not resolve until indices have been created.
If you&#39;re using the <code>db</code> options, or call <code>database</code>, then you may still need to listen for the <code>ready</code> event before saving jobs. <code>agenda.start()</code> will still wait for the connection to be opened.</li>
<li><code>error</code> - called when Agenda mongo connection process has thrown an error</li>
</ul>
<pre><code class="language-js"><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:defining-job-processors" class="tsd-anchor"></a><h2><a href="#md:defining-job-processors">Defining Job Processors</a></h2><p>Before you can use a job, you must define its processing behavior.</p>
<a id="md:definejobname-fn-options" class="tsd-anchor"></a><h3><a href="#md:definejobname-fn-options">define(jobName, fn, [options])</a></h3><p>Defines a job with the name of <code>jobName</code>. When a job of <code>jobName</code> gets run, it
will be passed to <code>fn(job, done)</code>. To maintain asynchronous behavior, you may
either provide a Promise-returning function in <code>fn</code> <em>or</em> provide <code>done</code> as a
second parameter to <code>fn</code>. If <code>done</code> is specified in the function signature, you
must call <code>done()</code> when you are processing the job. If your function is
synchronous or returns a Promise, you may omit <code>done</code> from the signature.</p>
<p><code>options</code> is an optional argument which can overwrite the defaults. It can take
the following:</p>
<ul>
<li><code>concurrency</code>: <code>number</code> maximum number of that job that can be running at once (per instance of agenda)</li>
<li><code>lockLimit</code>: <code>number</code> maximum number of that job that can be locked at once (per instance of agenda)</li>
<li><code>lockLifetime</code>: <code>number</code> interval in ms of how long the job stays locked for (see <a href="#md:multiple-job-processors">multiple job processors</a> for more info).
A job will automatically unlock once a returned promise resolves/rejects (or if <code>done</code> is specified in the signature and <code>done()</code> is called).</li>
<li><code>priority</code>: <code>(lowest|low|normal|high|highest|number)</code> specifies the priority
of the job. Higher priority jobs will run first. See the priority mapping
below</li>
</ul>
<p>Priority mapping:</p>
<pre><code><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-9">highest</span><span class="hl-1">: </span><span class="hl-4">20</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">high</span><span class="hl-1">: </span><span class="hl-4">10</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">normal</span><span class="hl-1">: </span><span class="hl-4">0</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">low</span><span class="hl-1">: -</span><span class="hl-4">10</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">lowest</span><span class="hl-1">: -</span><span class="hl-4">20</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>Async Job:</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;some long running job&#39;</span><span class="hl-1">, </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">data</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">doSomelengthyTask</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">formatThatData</span><span class="hl-1">(</span><span class="hl-0">data</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">sendThatData</span><span class="hl-1">(</span><span class="hl-0">data</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<p>Async Job (using <code>done</code>):</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;some long running job&#39;</span><span class="hl-1">, (</span><span class="hl-0">job</span><span class="hl-1">, </span><span class="hl-0">done</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">doSomelengthyTask</span><span class="hl-1">(</span><span class="hl-0">data</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">formatThatData</span><span class="hl-1">(</span><span class="hl-0">data</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-2">sendThatData</span><span class="hl-1">(</span><span class="hl-0">data</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-2">done</span><span class="hl-1">();</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<p>Sync Job:</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;say hello&#39;</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;Hello!&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<p><code>define()</code> acts like an assignment: if <code>define(jobName, ...)</code> is called multiple times (e.g. every time your script starts), the definition in the last call will overwrite the previous one. Thus, if you <code>define</code> the <code>jobName</code> only once in your code, it&#39;s safe for that call to execute multiple times.</p>
<a id="md:creating-jobs" class="tsd-anchor"></a><h2><a href="#md:creating-jobs">Creating Jobs</a></h2><a id="md:everyinterval-name-data-options" class="tsd-anchor"></a><h3><a href="#md:everyinterval-name-data-options">every(interval, name, [data], [options])</a></h3><p>Runs job <code>name</code> at the given <code>interval</code>. Optionally, data and options can be passed in.
Every creates a job of type <code>single</code>, which means that it will only create one
job in the database, even if that line is run multiple times. This lets you put
it in a file that may get run multiple times, such as <code>webserver.js</code> which may
reboot from time to time.</p>
<p><code>interval</code> can be a human-readable format <code>String</code>, a <a href="https://www.npmjs.com/package/cron-parser">cron format</a> <code>String</code>, or a <code>Number</code>.</p>
<p><code>data</code> is an optional argument that will be passed to the processing function
under <code>job.attrs.data</code>.</p>
<p><code>options</code> is an optional argument that will be passed to <a href="#md:repeateveryinterval-options"><code>job.repeatEvery</code></a>.
In order to use this argument, <code>data</code> must also be specified.</p>
<p>Returns the <code>job</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1">, </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">users</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">User</span><span class="hl-1">.</span><span class="hl-2">doSomethingReallyIntensive</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-2">processUserData</span><span class="hl-1">(</span><span class="hl-0">users</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;I print a report!&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">every</span><span class="hl-1">(</span><span class="hl-3">&#39;15 minutes&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>Optionally, <code>name</code> could be array of job names, which is convenient for scheduling
different jobs for same <code>interval</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">every</span><span class="hl-1">(</span><span class="hl-3">&#39;15 minutes&#39;</span><span class="hl-1">, [</span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;sendNotifications&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;updateUserRecords&#39;</span><span class="hl-1">]);</span>
</code><button>Copy</button></pre>
<p>In this case, <code>every</code> returns array of <code>jobs</code>.</p>
<a id="md:schedulewhen-name-data" class="tsd-anchor"></a><h3><a href="#md:schedulewhen-name-data">schedule(when, name, [data])</a></h3><p>Schedules a job to run <code>name</code> once at a given time. <code>when</code> can be a <code>Date</code> or a
<code>String</code> such as <code>tomorrow at 5pm</code>.</p>
<p><code>data</code> is an optional argument that will be passed to the processing function
under <code>job.attrs.data</code>.</p>
<p>Returns the <code>job</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">schedule</span><span class="hl-1">(</span><span class="hl-3">&#39;tomorrow at noon&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1">, { </span><span class="hl-0">userCount:</span><span class="hl-1"> </span><span class="hl-4">100</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<p>Optionally, <code>name</code> could be array of job names, similar to the <code>every</code> method.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">schedule</span><span class="hl-1">(</span><span class="hl-3">&#39;tomorrow at noon&#39;</span><span class="hl-1">, [</span><br/><span class="hl-1">    </span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&#39;sendNotifications&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&#39;updateUserRecords&#39;</span><br/><span class="hl-1">]);</span>
</code><button>Copy</button></pre>
<p>In this case, <code>schedule</code> returns array of <code>jobs</code>.</p>
<a id="md:nowname-data" class="tsd-anchor"></a><h3><a href="#md:nowname-data">now(name, [data])</a></h3><p>Schedules a job to run <code>name</code> once immediately.</p>
<p><code>data</code> is an optional argument that will be passed to the processing function
under <code>job.attrs.data</code>.</p>
<p>Returns the <code>job</code>.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">now</span><span class="hl-1">(</span><span class="hl-3">&#39;do the hokey pokey&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<a id="md:createjobname-data" class="tsd-anchor"></a><h3><a href="#md:createjobname-data">create(jobName, data)</a></h3><p>Returns an instance of a <code>jobName</code> with <code>data</code>. This does <em>NOT</em> save the job in
the database. See below to learn how to manually work with jobs.</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">job</span><span class="hl-1"> = </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">create</span><span class="hl-1">(</span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1">, { </span><span class="hl-0">userCount:</span><span class="hl-1"> </span><span class="hl-4">100</span><span class="hl-1"> });</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span><br/><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;Job successfully saved&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<a id="md:managing-jobs" class="tsd-anchor"></a><h2><a href="#md:managing-jobs">Managing Jobs</a></h2><a id="md:jobsmongodb-native-query-mongodb-native-sort-mongodb-native-limit-mongodb-native-skip" class="tsd-anchor"></a><h3><a href="#md:jobsmongodb-native-query-mongodb-native-sort-mongodb-native-limit-mongodb-native-skip">jobs(mongodb-native query, mongodb-native sort, mongodb-native limit, mongodb-native skip)</a></h3><p>Lets you query (then sort, limit and skip the result) all of the jobs in the agenda job&#39;s database. These are full <a href="https://github.com/mongodb/node-mongodb-native">mongodb-native</a> <code>find</code>, <code>sort</code>, <code>limit</code> and <code>skip</code> commands. See mongodb-native&#39;s documentation for details.</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">jobs</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">jobs</span><span class="hl-1">({ </span><span class="hl-0">name:</span><span class="hl-1"> </span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1"> }, { </span><span class="hl-0">data:</span><span class="hl-1"> -</span><span class="hl-4">1</span><span class="hl-1"> }, </span><span class="hl-4">3</span><span class="hl-1">, </span><span class="hl-4">1</span><span class="hl-1">);</span><br/><span class="hl-7">// Work with jobs (see below)</span>
</code><button>Copy</button></pre>
<a id="md:cancelmongodb-native-query" class="tsd-anchor"></a><h3><a href="#md:cancelmongodb-native-query">cancel(mongodb-native query)</a></h3><p>Cancels any jobs matching the passed mongodb-native query, and removes them from the database. Returns a Promise resolving to the number of cancelled jobs, or rejecting on error.</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">numRemoved</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">cancel</span><span class="hl-1">({ </span><span class="hl-0">name:</span><span class="hl-1"> </span><span class="hl-3">&#39;printAnalyticsReport&#39;</span><span class="hl-1"> });</span>
</code><button>Copy</button></pre>
<p>This functionality can also be achieved by first retrieving all the jobs from the database using <code>agenda.jobs()</code>, looping through the resulting array and calling <code>job.remove()</code> on each. It is however preferable to use <code>agenda.cancel()</code> for this use case, as this ensures the operation is atomic.</p>
<a id="md:purge" class="tsd-anchor"></a><h3><a href="#md:purge">purge()</a></h3><p>Removes all jobs in the database without defined behaviors. Useful if you change a definition name and want to remove old jobs. Returns a Promise resolving to the number of removed jobs, or rejecting on error.</p>
<p><em>IMPORTANT:</em> Do not run this before you finish defining all of your jobs. If you do, you will nuke your database of jobs.</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">numRemoved</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">purge</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:starting-the-job-processor" class="tsd-anchor"></a><h2><a href="#md:starting-the-job-processor">Starting the job processor</a></h2><p>To get agenda to start processing jobs from the database you must start it. This
will schedule an interval (based on <code>processEvery</code>) to check for new jobs and
run them. You can also stop the queue.</p>
<a id="md:start" class="tsd-anchor"></a><h3><a href="#md:start">start</a></h3><p>Starts the job queue processing, checking <a href="#md:processeveryinterval"><code>processEvery</code></a> time to see if there
are new jobs. Must be called <em>after</em> <code>processEvery</code>, and <em>before</em> any job scheduling (e.g. <code>every</code>).</p>
<a id="md:stop" class="tsd-anchor"></a><h3><a href="#md:stop">stop</a></h3><p>Stops the job queue processing. Unlocks currently running jobs.</p>
<p>This can be very useful for graceful shutdowns so that currently running/grabbed jobs are abandoned so that other
job queues can grab them / they are unlocked should the job queue start again. Here is an example of how to do a graceful
shutdown.</p>
<pre><code class="language-js"><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-5">function</span><span class="hl-1"> </span><span class="hl-2">graceful</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">stop</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">exit</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;SIGTERM&#39;</span><span class="hl-1">, </span><span class="hl-0">graceful</span><span class="hl-1">);</span><br/><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;SIGINT&#39;</span><span class="hl-1">, </span><span class="hl-0">graceful</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<a id="md:multiple-job-processors" class="tsd-anchor"></a><h2><a href="#md:multiple-job-processors">Multiple job processors</a></h2><p>Sometimes you may want to have multiple node instances / machines process from
the same queue. Agenda supports a locking mechanism to ensure that multiple
queues don&#39;t process the same job.</p>
<p>You can configure the locking mechanism by specifying <code>lockLifetime</code> as an
interval when defining the job.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-3">&#39;someJob&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    (</span><span class="hl-0">job</span><span class="hl-1">, </span><span class="hl-0">cb</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">// Do something in 10 seconds or less...</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    { </span><span class="hl-0">lockLifetime:</span><span class="hl-1"> </span><span class="hl-4">10000</span><span class="hl-1"> }</span><br/><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>This will ensure that no other job processor (this one included) attempts to run the job again
for the next 10 seconds. If you have a particularly long running job, you will want to
specify a longer lockLifetime.</p>
<p>By default it is 10 minutes. Typically you shouldn&#39;t have a job that runs for 10 minutes,
so this is really insurance should the job queue crash before the job is unlocked.</p>
<p>When a job is finished (i.e. the returned promise resolves/rejects or <code>done</code> is
specified in the signature and <code>done()</code> is called), it will automatically unlock.</p>
<a id="md:manually-working-with-a-job" class="tsd-anchor"></a><h2><a href="#md:manually-working-with-a-job">Manually working with a job</a></h2><p>A job instance has many instance methods. All mutating methods must be followed
with a call to <code>await job.save()</code> in order to persist the changes to the database.</p>
<a id="md:repeateveryinterval-options" class="tsd-anchor"></a><h3><a href="#md:repeateveryinterval-options">repeatEvery(interval, [options])</a></h3><p>Specifies an <code>interval</code> on which the job should repeat. The job runs at the time of defining as well in configured intervals, that is &quot;run <em>now</em> and in intervals&quot;.</p>
<p><code>interval</code> can be a human-readable format <code>String</code>, a <a href="https://www.npmjs.com/package/cron-parser">cron format</a> <code>String</code>, or a <code>Number</code>.</p>
<p><code>options</code> is an optional argument containing:</p>
<p><code>options.timezone</code>: should be a string as accepted by <a href="https://momentjs.com/timezone/">moment-timezone</a> and is considered when using an interval in the cron string format.</p>
<p><code>options.skipImmediate</code>: <code>true</code> | <code>false</code> (default) Setting this <code>true</code> will skip the immediate run. The first run will occur only in configured interval.</p>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">repeatEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;10 minutes&#39;</span><span class="hl-1">);</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">repeatEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;3 minutes&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-0">skipImmediate:</span><span class="hl-1"> </span><span class="hl-5">true</span><br/><span class="hl-1">});</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">repeatEvery</span><span class="hl-1">(</span><span class="hl-3">&#39;0 6 * * *&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-0">timezone:</span><span class="hl-1"> </span><span class="hl-3">&#39;America/New_York&#39;</span><br/><span class="hl-1">});</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:repeatattime" class="tsd-anchor"></a><h3><a href="#md:repeatattime">repeatAt(time)</a></h3><p>Specifies a <code>time</code> when the job should repeat. <a href="https://github.com/matthewmueller/date#examples">Possible values</a></p>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">repeatAt</span><span class="hl-1">(</span><span class="hl-3">&#39;3:30pm&#39;</span><span class="hl-1">);</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:scheduletime" class="tsd-anchor"></a><h3><a href="#md:scheduletime">schedule(time)</a></h3><p>Specifies the next <code>time</code> at which the job should run.</p>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">schedule</span><span class="hl-1">(</span><span class="hl-3">&#39;tomorrow at 6pm&#39;</span><span class="hl-1">);</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:prioritypriority" class="tsd-anchor"></a><h3><a href="#md:prioritypriority">priority(priority)</a></h3><p>Specifies the <code>priority</code> weighting of the job. Can be a number or a string from
the above priority table.</p>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">priority</span><span class="hl-1">(</span><span class="hl-3">&#39;low&#39;</span><span class="hl-1">);</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:uniqueproperties-options" class="tsd-anchor"></a><h3><a href="#md:uniqueproperties-options">unique(properties, [options])</a></h3><p>Ensure that only one instance of this job exists with the specified properties</p>
<p><code>options</code> is an optional argument which can overwrite the defaults. It can take
the following:</p>
<ul>
<li><code>insertOnly</code>: <code>boolean</code> will prevent any properties from persisting if the job already exists. Defaults to false.</li>
</ul>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">unique</span><span class="hl-1">({ </span><span class="hl-3">&#39;data.type&#39;</span><span class="hl-0">:</span><span class="hl-1"> </span><span class="hl-3">&#39;active&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;data.userId&#39;</span><span class="hl-0">:</span><span class="hl-1"> </span><span class="hl-3">&#39;123&#39;</span><span class="hl-1">, </span><span class="hl-0">nextRunAt:</span><span class="hl-1"> </span><span class="hl-0">date</span><span class="hl-1"> });</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<p><em>IMPORTANT:</em> To avoid high CPU usage by MongoDB, make sure to create an index on the used fields, like <code>data.type</code> and <code>data.userId</code> for the example above.</p>
<a id="md:failreason" class="tsd-anchor"></a><h3><a href="#md:failreason">fail(reason)</a></h3><p>Sets <code>job.attrs.failedAt</code> to <code>now</code>, and sets <code>job.attrs.failReason</code> to <code>reason</code>.</p>
<p>Optionally, <code>reason</code> can be an error, in which case <code>job.attrs.failReason</code> will
be set to <code>error.message</code></p>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">fail</span><span class="hl-1">(</span><span class="hl-3">&#39;insufficient disk space&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">// or</span><br/><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">fail</span><span class="hl-1">(</span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Error</span><span class="hl-1">(</span><span class="hl-3">&#39;insufficient disk space&#39;</span><span class="hl-1">));</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:runcallback" class="tsd-anchor"></a><h3><a href="#md:runcallback">run(callback)</a></h3><p>Runs the given <code>job</code> and calls <code>callback(err, job)</code> upon completion. Normally
you never need to call this manually.</p>
<pre><code class="language-js"><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">run</span><span class="hl-1">((</span><span class="hl-0">err</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&quot;I don&#39;t know why you would need to do this...&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<a id="md:save" class="tsd-anchor"></a><h3><a href="#md:save">save()</a></h3><p>Saves the <code>job.attrs</code> into the database. Returns a Promise resolving to a Job instance, or rejecting on error.</p>
<pre><code class="language-js"><span class="hl-8">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">cosole</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;Successfully saved job to collection&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">} </span><span class="hl-8">catch</span><span class="hl-1"> (</span><span class="hl-0">e</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">error</span><span class="hl-1">(</span><span class="hl-3">&#39;Error saving job to collection&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:remove" class="tsd-anchor"></a><h3><a href="#md:remove">remove()</a></h3><p>Removes the <code>job</code> from the database. Returns a Promise resolving to the number of jobs removed, or rejecting on error.</p>
<pre><code class="language-js"><span class="hl-8">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">remove</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;Successfully removed job from collection&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">} </span><span class="hl-8">catch</span><span class="hl-1"> (</span><span class="hl-0">e</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">error</span><span class="hl-1">(</span><span class="hl-3">&#39;Error removing job from collection&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:disable" class="tsd-anchor"></a><h3><a href="#md:disable">disable()</a></h3><p>Disables the <code>job</code>. Upcoming runs won&#39;t execute.</p>
<a id="md:enable" class="tsd-anchor"></a><h3><a href="#md:enable">enable()</a></h3><p>Enables the <code>job</code> if it got disabled before. Upcoming runs will execute.</p>
<a id="md:touch" class="tsd-anchor"></a><h3><a href="#md:touch">touch()</a></h3><p>Resets the lock on the job. Useful to indicate that the job hasn&#39;t timed out
when you have very long running jobs. The call returns a promise that resolves
when the job&#39;s lock has been renewed.</p>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;super long job&#39;</span><span class="hl-1">, </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">doSomeLongTask</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">touch</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">doAnotherLongTask</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">touch</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">finishOurLongTasks</span><span class="hl-1">();</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<a id="md:job-queue-events" class="tsd-anchor"></a><h2><a href="#md:job-queue-events">Job Queue Events</a></h2><p>An instance of an agenda will emit the following events:</p>
<ul>
<li><code>start</code> - called just before a job starts</li>
<li><code>start:job name</code> - called just before the specified job starts</li>
</ul>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;start&#39;</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;Job %s starting&#39;</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-0">attrs</span><span class="hl-1">.</span><span class="hl-0">name</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<ul>
<li><code>complete</code> - called when a job finishes, regardless of if it succeeds or fails</li>
<li><code>complete:job name</code> - called when a job finishes, regardless of if it succeeds or fails</li>
</ul>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;complete&#39;</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">`Job </span><span class="hl-5">${</span><span class="hl-0">job</span><span class="hl-10">.</span><span class="hl-0">attrs</span><span class="hl-10">.</span><span class="hl-0">name</span><span class="hl-5">}</span><span class="hl-3"> finished`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<ul>
<li><code>success</code> - called when a job finishes successfully</li>
<li><code>success:job name</code> - called when a job finishes successfully</li>
</ul>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;success:send email&#39;</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">`Sent Email Successfully to </span><span class="hl-5">${</span><span class="hl-0">job</span><span class="hl-10">.</span><span class="hl-0">attrs</span><span class="hl-10">.</span><span class="hl-0">data</span><span class="hl-10">.</span><span class="hl-0">to</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<ul>
<li><code>fail</code> - called when a job throws an error</li>
<li><code>fail:job name</code> - called when a job throws an error</li>
</ul>
<pre><code class="language-js"><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;fail:send email&#39;</span><span class="hl-1">, (</span><span class="hl-0">err</span><span class="hl-1">, </span><span class="hl-0">job</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">`Job failed with error: </span><span class="hl-5">${</span><span class="hl-0">err</span><span class="hl-10">.</span><span class="hl-0">message</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<a id="md:frequently-asked-questions" class="tsd-anchor"></a><h2><a href="#md:frequently-asked-questions">Frequently Asked Questions</a></h2><a id="md:what-is-the-order-in-which-jobs-run" class="tsd-anchor"></a><h3><a href="#md:what-is-the-order-in-which-jobs-run">What is the order in which jobs run?</a></h3><p>Jobs are run with priority in a first in first out order (so they will be run in the order they were scheduled AND with respect to highest priority).</p>
<p>For example, if we have two jobs named &quot;send-email&quot; queued (both with the same priority), and the first job is queued at 3:00 PM and second job is queued at 3:05 PM with the same <code>priority</code> value, then the first job will run first if we start to send &quot;send-email&quot; jobs at 3:10 PM. However if the first job has a priority of <code>5</code> and the second job has a priority of <code>10</code>, then the second will run first (priority takes precedence) at 3:10 PM.</p>
<p>The default <a href="https://docs.mongodb.com/manual/reference/method/cursor.sort/">MongoDB sort object</a> is <code>{ nextRunAt: 1, priority: -1 }</code> and can be changed through the option <code>sort</code> when configuring Agenda.</p>
<a id="md:what-is-the-difference-between-locklimit-and-maxconcurrency" class="tsd-anchor"></a><h3><a href="#md:what-is-the-difference-between-locklimit-and-maxconcurrency">What is the difference between <code>lockLimit</code> and <code>maxConcurrency</code>?</a></h3><p>Agenda will lock jobs 1 by one, setting the <code>lockedAt</code> property in mongoDB, and creating an instance of the <code>Job</code> class which it caches into the <code>_lockedJobs</code> array. This defaults to having no limit, but can be managed using lockLimit. If all jobs will need to be run before agenda&#39;s next interval (set via <code>agenda.processEvery</code>), then agenda will attempt to lock all jobs.</p>
<p>Agenda will also pull jobs from <code>_lockedJobs</code> and into <code>_runningJobs</code>. These jobs are actively being worked on by user code, and this is limited by <code>maxConcurrency</code> (defaults to 20).</p>
<p>If you have multiple instances of agenda processing the same job definition with a fast repeat time you may find they get unevenly loaded. This is because they will compete to lock as many jobs as possible, even if they don&#39;t have enough concurrency to process them. This can be resolved by tweaking the <code>maxConcurrency</code> and <code>lockLimit</code> properties.</p>
<a id="md:sample-project-structure" class="tsd-anchor"></a><h3><a href="#md:sample-project-structure">Sample Project Structure?</a></h3><p>Agenda doesn&#39;t have a preferred project structure and leaves it to the user to
choose how they would like to use it. That being said, you can check out the
<a href="#md:example-project-structure">example project structure</a> below.</p>
<a id="md:can-i-donate" class="tsd-anchor"></a><h3><a href="#md:can-i-donate">Can I Donate?</a></h3><p>Thanks! I&#39;m flattered, but it&#39;s really not necessary. If you really want to, you can find my <a href="https://www.gittip.com/rschmukler/">gittip here</a>.</p>
<a id="md:web-interface" class="tsd-anchor"></a><h3><a href="#md:web-interface">Web Interface?</a></h3><p>Agenda itself does not have a web interface built in but we do offer stand-alone web interface <a href="https://github.com/agenda/agendash">Agendash</a>:</p>
<p><a href="https://raw.githubusercontent.com/agenda/agendash/master/job-details.png"><img src="https://raw.githubusercontent.com/agenda/agendash/master/job-details.png" style="max-width:100%" alt="Agendash interface"></a></p>
<a id="md:mongo-vs-redis" class="tsd-anchor"></a><h3><a href="#md:mongo-vs-redis">Mongo vs Redis</a></h3><p>The decision to use Mongo instead of Redis is intentional. Redis is often used for
non-essential data (such as sessions) and without configuration doesn&#39;t
guarantee the same level of persistence as Mongo (should the server need to be
restarted/crash).</p>
<p>Agenda decides to focus on persistence without requiring special configuration
of Redis (thereby degrading the performance of the Redis server on non-critical
data, such as sessions).</p>
<p>Ultimately if enough people want a Redis driver instead of Mongo, I will write
one. (Please open an issue requesting it). For now, Agenda decided to focus on
guaranteed persistence.</p>
<a id="md:spawning--forking-processes" class="tsd-anchor"></a><h3><a href="#md:spawning--forking-processes">Spawning / forking processes</a></h3><p>Ultimately Agenda can work from a single job queue across multiple machines, node processes, or forks. If you are interested in having more than one worker, <a href="http://github.com/bars3s">Bars3s</a> has written up a fantastic example of how one might do it:</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">cluster</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;cluster&#39;</span><span class="hl-1">);</span><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">os</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;os&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">httpServer</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;./app/http-server&#39;</span><span class="hl-1">);</span><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">jobWorker</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;./app/job-worker&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">jobWorkers</span><span class="hl-1"> = [];</span><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">webWorkers</span><span class="hl-1"> = [];</span><br/><br/><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">cluster</span><span class="hl-1">.</span><span class="hl-0">isMaster</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">cpuCount</span><span class="hl-1"> = </span><span class="hl-0">os</span><span class="hl-1">.</span><span class="hl-2">cpus</span><span class="hl-1">().</span><span class="hl-0">length</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-7">// Create a worker for each CPU</span><br/><span class="hl-1">    </span><span class="hl-8">for</span><span class="hl-1"> (</span><span class="hl-5">let</span><span class="hl-1"> </span><span class="hl-0">i</span><span class="hl-1"> = </span><span class="hl-4">0</span><span class="hl-1">; </span><span class="hl-0">i</span><span class="hl-1"> &lt; </span><span class="hl-0">cpuCount</span><span class="hl-1">; </span><span class="hl-0">i</span><span class="hl-1"> += </span><span class="hl-4">1</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-2">addJobWorker</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-2">addWebWorker</span><span class="hl-1">();</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-0">cluster</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;exit&#39;</span><span class="hl-1">, (</span><span class="hl-0">worker</span><span class="hl-1">, </span><span class="hl-0">code</span><span class="hl-1">, </span><span class="hl-0">signal</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">jobWorkers</span><span class="hl-1">.</span><span class="hl-2">indexOf</span><span class="hl-1">(</span><span class="hl-0">worker</span><span class="hl-1">.</span><span class="hl-0">id</span><span class="hl-1">) !== -</span><span class="hl-4">1</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-3">`job worker </span><span class="hl-5">${</span><span class="hl-0">worker</span><span class="hl-10">.</span><span class="hl-0">process</span><span class="hl-10">.</span><span class="hl-0">pid</span><span class="hl-5">}</span><span class="hl-3"> exited (signal: </span><span class="hl-5">${</span><span class="hl-0">signal</span><span class="hl-5">}</span><span class="hl-3">). Trying to respawn...`</span><br/><span class="hl-1">            );</span><br/><span class="hl-1">            </span><span class="hl-2">removeJobWorker</span><span class="hl-1">(</span><span class="hl-0">worker</span><span class="hl-1">.</span><span class="hl-0">id</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-2">addJobWorker</span><span class="hl-1">();</span><br/><span class="hl-1">        }</span><br/><br/><span class="hl-1">        </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">webWorkers</span><span class="hl-1">.</span><span class="hl-2">indexOf</span><span class="hl-1">(</span><span class="hl-0">worker</span><span class="hl-1">.</span><span class="hl-0">id</span><span class="hl-1">) !== -</span><span class="hl-4">1</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-3">`http worker </span><span class="hl-5">${</span><span class="hl-0">worker</span><span class="hl-10">.</span><span class="hl-0">process</span><span class="hl-10">.</span><span class="hl-0">pid</span><span class="hl-5">}</span><span class="hl-3"> exited (signal: </span><span class="hl-5">${</span><span class="hl-0">signal</span><span class="hl-5">}</span><span class="hl-3">). Trying to respawn...`</span><br/><span class="hl-1">            );</span><br/><span class="hl-1">            </span><span class="hl-2">removeWebWorker</span><span class="hl-1">(</span><span class="hl-0">worker</span><span class="hl-1">.</span><span class="hl-0">id</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-2">addWebWorker</span><span class="hl-1">();</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">} </span><span class="hl-8">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">env</span><span class="hl-1">.</span><span class="hl-0">web</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">`start http server: </span><span class="hl-5">${</span><span class="hl-0">cluster</span><span class="hl-10">.</span><span class="hl-0">worker</span><span class="hl-10">.</span><span class="hl-0">id</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-7">// Initialize the http server here</span><br/><span class="hl-1">        </span><span class="hl-0">httpServer</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">();</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">env</span><span class="hl-1">.</span><span class="hl-0">job</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">`start job server: </span><span class="hl-5">${</span><span class="hl-0">cluster</span><span class="hl-10">.</span><span class="hl-0">worker</span><span class="hl-10">.</span><span class="hl-0">id</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-7">// Initialize the Agenda here</span><br/><span class="hl-1">        </span><span class="hl-0">jobWorker</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">();</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">function</span><span class="hl-1"> </span><span class="hl-2">addWebWorker</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-0">webWorkers</span><span class="hl-1">.</span><span class="hl-2">push</span><span class="hl-1">(</span><span class="hl-0">cluster</span><span class="hl-1">.</span><span class="hl-2">fork</span><span class="hl-1">({ </span><span class="hl-0">web:</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1"> }).</span><span class="hl-0">id</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">function</span><span class="hl-1"> </span><span class="hl-2">addJobWorker</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-0">jobWorkers</span><span class="hl-1">.</span><span class="hl-2">push</span><span class="hl-1">(</span><span class="hl-0">cluster</span><span class="hl-1">.</span><span class="hl-2">fork</span><span class="hl-1">({ </span><span class="hl-0">job:</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1"> }).</span><span class="hl-0">id</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">function</span><span class="hl-1"> </span><span class="hl-2">removeWebWorker</span><span class="hl-1">(</span><span class="hl-0">id</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">webWorkers</span><span class="hl-1">.</span><span class="hl-2">splice</span><span class="hl-1">(</span><span class="hl-0">webWorkers</span><span class="hl-1">.</span><span class="hl-2">indexOf</span><span class="hl-1">(</span><span class="hl-0">id</span><span class="hl-1">), </span><span class="hl-4">1</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">function</span><span class="hl-1"> </span><span class="hl-2">removeJobWorker</span><span class="hl-1">(</span><span class="hl-0">id</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">jobWorkers</span><span class="hl-1">.</span><span class="hl-2">splice</span><span class="hl-1">(</span><span class="hl-0">jobWorkers</span><span class="hl-1">.</span><span class="hl-2">indexOf</span><span class="hl-1">(</span><span class="hl-0">id</span><span class="hl-1">), </span><span class="hl-4">1</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:recovering-lost-mongo-connections-quotauto_reconnectquot" class="tsd-anchor"></a><h3><a href="#md:recovering-lost-mongo-connections-quotauto_reconnectquot">Recovering lost Mongo connections (&quot;auto_reconnect&quot;)</a></h3><p>Agenda is configured by default to automatically reconnect indefinitely, emitting an <a href="#md:agenda-events">error event</a>
when no connection is available on each <a href="#md:processeveryinterval">process tick</a>, allowing you to restore the Mongo
instance without having to restart the application.</p>
<p>However, if you are using an <a href="#md:mongomongoclientinstance">existing Mongo client</a>
you&#39;ll need to configure the <code>reconnectTries</code> and <code>reconnectInterval</code> <a href="http://mongodb.github.io/node-mongodb-native/3.0/reference/connecting/connection-settings/">connection settings</a>
manually, otherwise you&#39;ll find that Agenda will throw an error with the message &quot;MongoDB connection is not recoverable,
application restart required&quot; if the connection cannot be recovered within 30 seconds.</p>
<a id="md:example-project-structure" class="tsd-anchor"></a><h1><a href="#md:example-project-structure">Example Project Structure</a></h1><p>Agenda will only process jobs that it has definitions for. This allows you to
selectively choose which jobs a given agenda will process.</p>
<p>Consider the following project structure, which allows us to share models with
the rest of our code base, and specify which jobs a worker processes, if any at
all.</p>
<pre><code><span class="hl-1">- </span><span class="hl-0">server</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">- </span><span class="hl-0">worker</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-0">lib</span><span class="hl-1">/</span><br/><span class="hl-1">  - </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">  </span><span class="hl-0">controllers</span><span class="hl-1">/</span><br/><span class="hl-1">    - </span><span class="hl-0">user</span><span class="hl-1">-</span><span class="hl-0">controller</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">  </span><span class="hl-0">jobs</span><span class="hl-1">/</span><br/><span class="hl-1">    - </span><span class="hl-0">email</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">    - </span><span class="hl-0">video</span><span class="hl-1">-</span><span class="hl-0">processing</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">    - </span><span class="hl-0">image</span><span class="hl-1">-</span><span class="hl-0">processing</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">   </span><span class="hl-0">models</span><span class="hl-1">/</span><br/><span class="hl-1">     - </span><span class="hl-0">user</span><span class="hl-1">-</span><span class="hl-0">model</span><span class="hl-1">.</span><span class="hl-0">js</span><br/><span class="hl-1">     - </span><span class="hl-0">blog</span><span class="hl-1">-</span><span class="hl-0">post</span><span class="hl-1">.</span><span class="hl-0">model</span><span class="hl-1">.</span><span class="hl-0">js</span>
</code><button>Copy</button></pre>
<p>Sample job processor (eg. <code>jobs/email.js</code>)</p>
<pre><code class="language-js"><span class="hl-5">let</span><span class="hl-1"> </span><span class="hl-0">email</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;some-email-lib&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">User</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;../models/user-model.js&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-11">module</span><span class="hl-1">.</span><span class="hl-11">exports</span><span class="hl-1"> = </span><span class="hl-5">function</span><span class="hl-1"> (</span><span class="hl-0">agenda</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;registration email&#39;</span><span class="hl-1">, </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">User</span><span class="hl-1">.</span><span class="hl-2">get</span><span class="hl-1">(</span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-0">attrs</span><span class="hl-1">.</span><span class="hl-0">data</span><span class="hl-1">.</span><span class="hl-0">userId</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">email</span><span class="hl-1">(</span><span class="hl-0">user</span><span class="hl-1">.</span><span class="hl-2">email</span><span class="hl-1">(), </span><span class="hl-3">&#39;Thanks for registering&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;Thanks for registering &#39;</span><span class="hl-1"> + </span><span class="hl-0">user</span><span class="hl-1">.</span><span class="hl-2">name</span><span class="hl-1">());</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">define</span><span class="hl-1">(</span><span class="hl-3">&#39;reset password&#39;</span><span class="hl-1">, </span><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">// Etc</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-7">// More email related jobs</span><br/><span class="hl-1">};</span>
</code><button>Copy</button></pre>
<p>lib/agenda.js</p>
<pre><code class="language-js"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">Agenda</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;agenda&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">connectionOpts</span><span class="hl-1"> = { </span><span class="hl-0">db:</span><span class="hl-1"> { </span><span class="hl-0">address:</span><span class="hl-1"> </span><span class="hl-3">&#39;localhost:27017/agenda-test&#39;</span><span class="hl-1">, </span><span class="hl-0">collection:</span><span class="hl-1"> </span><span class="hl-3">&#39;agendaJobs&#39;</span><span class="hl-1"> } };</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">(</span><span class="hl-0">connectionOpts</span><span class="hl-1">);</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">jobTypes</span><span class="hl-1"> = </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">env</span><span class="hl-1">.</span><span class="hl-6">JOB_TYPES</span><span class="hl-1"> ? </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">env</span><span class="hl-1">.</span><span class="hl-6">JOB_TYPES</span><span class="hl-1">.</span><span class="hl-2">split</span><span class="hl-1">(</span><span class="hl-3">&#39;,&#39;</span><span class="hl-1">) : [];</span><br/><br/><span class="hl-0">jobTypes</span><span class="hl-1">.</span><span class="hl-2">forEach</span><span class="hl-1">(</span><span class="hl-0">type</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;./jobs/&#39;</span><span class="hl-1"> + </span><span class="hl-0">type</span><span class="hl-1">)(</span><span class="hl-0">agenda</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">jobTypes</span><span class="hl-1">.</span><span class="hl-0">length</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">start</span><span class="hl-1">(); </span><span class="hl-7">// Returns a promise, which should be handled appropriately</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-11">module</span><span class="hl-1">.</span><span class="hl-11">exports</span><span class="hl-1"> = </span><span class="hl-0">agenda</span><span class="hl-1">;</span>
</code><button>Copy</button></pre>
<p>lib/controllers/user-controller.js</p>
<pre><code class="language-js"><span class="hl-5">let</span><span class="hl-1"> </span><span class="hl-0">app</span><span class="hl-1"> = </span><span class="hl-2">express</span><span class="hl-1">(),</span><br/><span class="hl-1">    </span><span class="hl-0">User</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;../models/user-model&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">agenda</span><span class="hl-1"> = </span><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;../worker.js&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-0">app</span><span class="hl-1">.</span><span class="hl-2">post</span><span class="hl-1">(</span><span class="hl-3">&#39;/users&#39;</span><span class="hl-1">, (</span><span class="hl-0">req</span><span class="hl-1">, </span><span class="hl-0">res</span><span class="hl-1">, </span><span class="hl-0">next</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">User</span><span class="hl-1">(</span><span class="hl-0">req</span><span class="hl-1">.</span><span class="hl-0">body</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">user</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">(</span><span class="hl-0">err</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">err</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-8">return</span><span class="hl-1"> </span><span class="hl-2">next</span><span class="hl-1">(</span><span class="hl-0">err</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">        </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">now</span><span class="hl-1">(</span><span class="hl-3">&#39;registration email&#39;</span><span class="hl-1">, { </span><span class="hl-0">userId:</span><span class="hl-1"> </span><span class="hl-0">user</span><span class="hl-1">.</span><span class="hl-2">primary</span><span class="hl-1">() });</span><br/><span class="hl-1">        </span><span class="hl-0">res</span><span class="hl-1">.</span><span class="hl-2">send</span><span class="hl-1">(</span><span class="hl-4">201</span><span class="hl-1">, </span><span class="hl-0">user</span><span class="hl-1">.</span><span class="hl-2">toJson</span><span class="hl-1">());</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">});</span>
</code><button>Copy</button></pre>
<p>worker.js</p>
<pre><code class="language-js"><span class="hl-2">require</span><span class="hl-1">(</span><span class="hl-3">&#39;./lib/agenda.js&#39;</span><span class="hl-1">);</span>
</code><button>Copy</button></pre>
<p>Now you can do the following in your project:</p>
<pre><code class="language-bash"><span class="hl-2">node</span><span class="hl-1"> </span><span class="hl-3">server.js</span>
</code><button>Copy</button></pre>
<p>Fire up an instance with no <code>JOB_TYPES</code>, giving you the ability to process jobs,
but not wasting resources processing jobs.</p>
<pre><code class="language-bash"><span class="hl-0">JOB_TYPES</span><span class="hl-1">=</span><span class="hl-3">email</span><span class="hl-1"> </span><span class="hl-2">node</span><span class="hl-1"> </span><span class="hl-3">server.js</span>
</code><button>Copy</button></pre>
<p>Allow your http server to process email jobs.</p>
<pre><code class="language-bash"><span class="hl-0">JOB_TYPES</span><span class="hl-1">=</span><span class="hl-3">email</span><span class="hl-1"> </span><span class="hl-2">node</span><span class="hl-1"> </span><span class="hl-3">worker.js</span>
</code><button>Copy</button></pre>
<p>Fire up an instance that processes email jobs.</p>
<pre><code class="language-bash"><span class="hl-0">JOB_TYPES</span><span class="hl-1">=</span><span class="hl-3">video-processing,image-processing</span><span class="hl-1"> </span><span class="hl-2">node</span><span class="hl-1"> </span><span class="hl-3">worker.js</span>
</code><button>Copy</button></pre>
<p>Fire up an instance that processes video-processing/image-processing jobs. Good for a heavy hitting server.</p>
<a id="md:debugging-issues" class="tsd-anchor"></a><h1><a href="#md:debugging-issues">Debugging Issues</a></h1><p>If you think you have encountered a bug, please feel free to report it here:</p>
<p><a href="https://github.com/hokify/agenda/issues/new">Submit Issue</a></p>
<p>Please provide us with as much details as possible such as:</p>
<ul>
<li>Agenda version</li>
<li>Environment (OSX, Linux, Windows, etc)</li>
<li>Small description of what happened</li>
<li>Any relevant stack track</li>
<li>Agenda logs (see below)</li>
</ul>
<a id="md:to-turn-on-logging-please-set-your-debug-env-variable-like-so" class="tsd-anchor"></a><h4><a href="#md:to-turn-on-logging-please-set-your-debug-env-variable-like-so">To turn on logging, please set your DEBUG env variable like so:</a></h4><ul>
<li>OSX: <code>DEBUG=&quot;agenda:*&quot; ts-node src/index.ts</code></li>
<li>Linux: <code>DEBUG=&quot;agenda:*&quot; ts-node src/index.ts</code></li>
<li>Windows CMD: <code>set DEBUG=agenda:*</code></li>
<li>Windows PowerShell: <code>$env:DEBUG = &quot;agenda:*&quot;</code></li>
</ul>
<p>While not necessary, attaching a text file with this debug information would
be extremely useful in debugging certain issues and is encouraged.</p>
<a id="md:known-issues" class="tsd-anchor"></a><h1><a href="#md:known-issues">Known Issues</a></h1><a id="md:quotmultiple-order-by-items-are-not-supported-please-specify-a-single-order-by-itemquot" class="tsd-anchor"></a><h4><a href="#md:quotmultiple-order-by-items-are-not-supported-please-specify-a-single-order-by-itemquot">&quot;Multiple order-by items are not supported. Please specify a single order-by item.&quot;</a></h4><p>When running Agenda on Azure cosmosDB, you might run into this issue caused by Agenda&#39;s sort query used for finding and locking the next job. To fix this, you can pass <a href="#md:sortquery">custom sort option</a>: <code>sort: { nextRunAt: 1 }</code></p>
<a id="md:performance" class="tsd-anchor"></a><h1><a href="#md:performance">Performance</a></h1><p>It is recommended to set this index if you use agendash:</p>
<pre><code><span class="hl-0">db</span><span class="hl-1">.</span><span class="hl-0">agendaJobs</span><span class="hl-1">.</span><span class="hl-2">ensureIndex</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;nextRunAt&quot;</span><span class="hl-0"> :</span><span class="hl-1"> -</span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;lastRunAt&quot;</span><span class="hl-0"> :</span><span class="hl-1"> -</span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;lastFinishedAt&quot;</span><span class="hl-0"> :</span><span class="hl-1"> -</span><span class="hl-4">1</span><br/><span class="hl-1">}, </span><span class="hl-3">&quot;agendash2&quot;</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>
<p>If you have one job definition with thousand of instances, you can add this index to improve internal sorting query
for faster sortings</p>
<pre><code><span class="hl-0">db</span><span class="hl-1">.</span><span class="hl-0">agendaJobs</span><span class="hl-1">.</span><span class="hl-2">ensureIndex</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;name&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;disabled&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;lockedAt&quot;</span><span class="hl-0"> :</span><span class="hl-1"> </span><span class="hl-4">1</span><br/><span class="hl-1">}, </span><span class="hl-3">&quot;findAndLockDeadJobs&quot;</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>
<a id="md:sandboxed-worker---use-child-processes" class="tsd-anchor"></a><h1><a href="#md:sandboxed-worker---use-child-processes">Sandboxed Worker - use child processes</a></h1><p>It&#39;s possible to start jobs in a child process, this helps for example for long running processes
to seperate them from the main thread. For example if one process consumes too much memory and gets killed,
it will not affect any others.
To use this feature, several steps are required.
1.) create a childWorker helper.
The subrocess has a complete seperate context, so there are no database connections or anything else that can be shared.
Therefore you have to ensure that all required connections and initializations are done here too. Furthermore
you also have to load the correct job definition so that agenda nows what code it must execute. Therefore 3 parameters
are passed to the childWorker: name, jobId and path to the job definition.</p>
<p>Example file can look like this:</p>
<p>childWorker.ts</p>
<pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-1"> </span><span class="hl-3">&#39;reflect-metadata&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">function</span><span class="hl-1"> </span><span class="hl-2">isCancelMessage</span><span class="hl-1">(</span><span class="hl-0">message</span><span class="hl-1">): </span><span class="hl-0">message</span><span class="hl-1"> </span><span class="hl-5">is</span><span class="hl-1"> { </span><span class="hl-9">type</span><span class="hl-1">: </span><span class="hl-3">&#39;cancel&#39;</span><span class="hl-1">; </span><span class="hl-9">error</span><span class="hl-1">: </span><span class="hl-0">string</span><span class="hl-1"> } {</span><br/><span class="hl-1">    </span><span class="hl-8">return</span><span class="hl-1"> </span><span class="hl-0">message</span><span class="hl-1"> !== </span><span class="hl-5">null</span><span class="hl-1"> &amp;&amp; </span><span class="hl-5">typeof</span><span class="hl-1"> </span><span class="hl-0">message</span><span class="hl-1"> === </span><span class="hl-3">&#39;object&#39;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-0">message</span><span class="hl-1">.</span><span class="hl-0">type</span><span class="hl-1"> === </span><span class="hl-3">&#39;cancel&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-1">(</span><span class="hl-5">async</span><span class="hl-1"> () </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">mongooseConnection</span><span class="hl-1"> = </span><span class="hl-7">/** connect to database */</span><br/><br/><span class="hl-1">  </span><span class="hl-7">/** do other required initializations */</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// get process arguments (name, jobId and path to agenda definition file)</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> [, , </span><span class="hl-6">name</span><span class="hl-1">, </span><span class="hl-6">jobId</span><span class="hl-1">, </span><span class="hl-6">agendaDefinition</span><span class="hl-1">] = </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">argv</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// set fancy process title</span><br/><span class="hl-1">    </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">title</span><span class="hl-1"> = </span><span class="hl-3">`</span><span class="hl-5">${</span><span class="hl-0">process</span><span class="hl-10">.</span><span class="hl-0">title</span><span class="hl-5">}</span><span class="hl-3"> (sub worker: </span><span class="hl-5">${</span><span class="hl-0">name</span><span class="hl-5">}</span><span class="hl-3">/</span><span class="hl-5">${</span><span class="hl-0">jobId</span><span class="hl-5">}</span><span class="hl-3">)`</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// initialize Agenda in &quot;forkedWorker&quot; mode</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">agenda</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Agenda</span><span class="hl-1">({ </span><span class="hl-0">name:</span><span class="hl-1"> </span><span class="hl-3">`subworker-</span><span class="hl-5">${</span><span class="hl-0">name</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-1">, </span><span class="hl-0">forkedWorker:</span><span class="hl-1"> </span><span class="hl-5">true</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-7">// connect agenda (but do not start it)</span><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">mongo</span><span class="hl-1">(</span><span class="hl-0">mongooseConnection</span><span class="hl-1">.</span><span class="hl-0">db</span><span class="hl-1"> </span><span class="hl-8">as</span><span class="hl-1"> </span><span class="hl-11">any</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-8">if</span><span class="hl-1"> (!</span><span class="hl-0">name</span><span class="hl-1"> || !</span><span class="hl-0">jobId</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-8">throw</span><span class="hl-1"> </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-2">Error</span><span class="hl-1">(</span><span class="hl-3">`invalid parameters: </span><span class="hl-5">${</span><span class="hl-6">JSON</span><span class="hl-10">.</span><span class="hl-2">stringify</span><span class="hl-10">(</span><span class="hl-0">process</span><span class="hl-10">.</span><span class="hl-0">argv</span><span class="hl-10">)</span><span class="hl-5">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// load job definition</span><br/><span class="hl-1">  </span><span class="hl-7">/** in this case the file is for example ../some/path/definitions.js</span><br/><span class="hl-7">  with a content like:</span><br/><span class="hl-7">  export default (agenda: Agenda, definitionOnly = false) =&gt; {</span><br/><span class="hl-7">    agenda.define(</span><br/><span class="hl-7">      &#39;some job&#39;,</span><br/><span class="hl-7">      async (notification: {</span><br/><span class="hl-7">        attrs: { data: { dealId: string; orderId: TypeObjectId&lt;IOrder&gt; } };</span><br/><span class="hl-7">      }) =&gt; {</span><br/><span class="hl-7">        // do something</span><br/><span class="hl-7">      }</span><br/><span class="hl-7">    );</span><br/><br/><span class="hl-7">    if (!definitionOnly) {</span><br/><span class="hl-7">        // here you can create scheduled jobs or other things</span><br/><span class="hl-7">    }</span><br/><span class="hl-7">    });</span><br/><span class="hl-7">  */</span><br/><span class="hl-1">    </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">agendaDefinition</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">loadDefinition</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-2">import</span><span class="hl-1">(</span><span class="hl-0">agendaDefinition</span><span class="hl-1">);</span><br/><span class="hl-1">        (</span><span class="hl-0">loadDefinition</span><span class="hl-1">.</span><span class="hl-0">default</span><span class="hl-1"> || </span><span class="hl-0">loadDefinition</span><span class="hl-1">)(</span><span class="hl-0">agenda</span><span class="hl-1">, </span><span class="hl-5">true</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// run this job now</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">job</span><span class="hl-1"> = </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">getForkedJob</span><span class="hl-1">(</span><span class="hl-0">jobId</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">on</span><span class="hl-1">(</span><span class="hl-3">&#39;message&#39;</span><span class="hl-1">, </span><span class="hl-0">message</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-2">isCancelMessage</span><span class="hl-1">(</span><span class="hl-0">message</span><span class="hl-1">)) {</span><br/><span class="hl-1">            </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">cancel</span><span class="hl-1">(</span><span class="hl-0">message</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-2">setTimeout</span><span class="hl-1">(() </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-7">// kill it after 10 seconds</span><br/><span class="hl-1">                </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">exit</span><span class="hl-1">(</span><span class="hl-4">2</span><span class="hl-1">);</span><br/><span class="hl-1">            }, </span><span class="hl-4">10000</span><span class="hl-1">);</span><br/><span class="hl-1">        } </span><span class="hl-8">else</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">log</span><span class="hl-1">(</span><span class="hl-3">&#39;got message&#39;</span><span class="hl-1">, </span><span class="hl-0">message</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">runJob</span><span class="hl-1">();</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// disconnect database and exit</span><br/><span class="hl-1">    </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">exit</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span><br/><span class="hl-1">})().</span><span class="hl-2">catch</span><span class="hl-1">(</span><span class="hl-0">err</span><span class="hl-1"> </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">console</span><span class="hl-1">.</span><span class="hl-2">error</span><span class="hl-1">(</span><span class="hl-3">&#39;err&#39;</span><span class="hl-1">, </span><span class="hl-0">err</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-8">if</span><span class="hl-1"> (</span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">send</span><span class="hl-1">(</span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-2">stringify</span><span class="hl-1">(</span><span class="hl-0">err</span><span class="hl-1">));</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-0">process</span><span class="hl-1">.</span><span class="hl-2">exit</span><span class="hl-1">(</span><span class="hl-4">1</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/>
</code><button>Copy</button></pre>
<p>Ensure to only define job definitions during this step, otherwise you create some
overhead (e.g. if you create new jobs inside the defintion files). That&#39;s why I call
the defintion file with agenda and a second paramter that is set to true. If this
parameter is true, I do not initialize any jobs (create jobs etc..)</p>
<p>2.) to use this, you have to enable it on a job. Set forkMode to true:</p>
<pre><code class="language-ts"><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">job</span><span class="hl-1"> = </span><span class="hl-0">agenda</span><span class="hl-1">.</span><span class="hl-2">create</span><span class="hl-1">(</span><span class="hl-3">&#39;some job&#39;</span><span class="hl-1">, { </span><span class="hl-0">meep:</span><span class="hl-1"> </span><span class="hl-4">1</span><span class="hl-1"> });</span><br/><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">forkMode</span><span class="hl-1">(</span><span class="hl-5">true</span><span class="hl-1">);</span><br/><span class="hl-8">await</span><span class="hl-1"> </span><span class="hl-0">job</span><span class="hl-1">.</span><span class="hl-2">save</span><span class="hl-1">();</span>
</code><button>Copy</button></pre>
<a id="md:acknowledgements" class="tsd-anchor"></a><h1><a href="#md:acknowledgements">Acknowledgements</a></h1><ul>
<li>Agenda was originally created by <a href="https://github.com/rschmukler">@rschmukler</a>.</li>
<li><a href="https://github.com/agenda/agendash">Agendash</a> was originally created by <a href="https://github.com/joeframbach">@joeframbach</a>.</li>
<li>These days Agenda has a great community of <a href="https://github.com/hokify/agenda/graphs/contributors">contributors</a> around it. Join us!</li>
</ul>
<a id="md:license" class="tsd-anchor"></a><h1><a href="#md:license">License</a></h1><p><a href="LICENSE.md">The MIT License</a></p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-index-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><h4 class="uppercase">Member Visibility</h4><form><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-private" name="private"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Private</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div><div class="tsd-theme-toggle"><h4 class="uppercase">Theme</h4><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-index-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><ul><li><ul><li><a href="#md:agenda"><span>Agenda</span></a></li><li><a href="#md:agenda-offers"><span>Agenda offers</span></a></li><li><ul><li><a href="#md:feature-comparison"><span>Feature <wbr/>Comparison</span></a></li></ul></li><li><a href="#md:installation"><span>Installation</span></a></li><li><a href="#md:example-usage"><span>Example <wbr/>Usage</span></a></li><li><a href="#md:full-documentation"><span>Full documentation</span></a></li><li><ul><li><a href="#md:table-of-contents"><span>Table of <wbr/>Contents</span></a></li><li><a href="#md:configuring-an-agenda"><span>Configuring an agenda</span></a></li><li><ul><li><a href="#md:databaseurl-collectionname-mongoclientoptions"><span>database(url, [collection<wbr/>Name], [<wbr/>Mongo<wbr/>Client<wbr/>Options])</span></a></li><li><a href="#md:mongodbinstance-collectionname"><span>mongo(db<wbr/>Instance, [collection<wbr/>Name])</span></a></li><li><a href="#md:namename"><span>name(name)</span></a></li><li><a href="#md:processeveryinterval"><span>process<wbr/>Every(interval)</span></a></li><li><a href="#md:maxconcurrencynumber"><span>max<wbr/>Concurrency(number)</span></a></li><li><a href="#md:defaultconcurrencynumber"><span>default<wbr/>Concurrency(number)</span></a></li><li><a href="#md:locklimitnumber"><span>lock<wbr/>Limit(number)</span></a></li><li><a href="#md:defaultlocklimitnumber"><span>default<wbr/>Lock<wbr/>Limit(number)</span></a></li><li><a href="#md:defaultlocklifetimenumber"><span>default<wbr/>Lock<wbr/>Lifetime(number)</span></a></li><li><a href="#md:sortquery"><span>sort(query)</span></a></li></ul></li><li><a href="#md:agenda-events"><span>Agenda <wbr/>Events</span></a></li><li><a href="#md:defining-job-processors"><span>Defining <wbr/>Job <wbr/>Processors</span></a></li><li><ul><li><a href="#md:definejobname-fn-options"><span>define(job<wbr/>Name, fn, [options])</span></a></li></ul></li><li><a href="#md:creating-jobs"><span>Creating <wbr/>Jobs</span></a></li><li><ul><li><a href="#md:everyinterval-name-data-options"><span>every(interval, name, [data], [options])</span></a></li><li><a href="#md:schedulewhen-name-data"><span>schedule(when, name, [data])</span></a></li><li><a href="#md:nowname-data"><span>now(name, [data])</span></a></li><li><a href="#md:createjobname-data"><span>create(job<wbr/>Name, data)</span></a></li></ul></li><li><a href="#md:managing-jobs"><span>Managing <wbr/>Jobs</span></a></li><li><ul><li><a href="#md:jobsmongodb-native-query-mongodb-native-sort-mongodb-native-limit-mongodb-native-skip"><span>jobs(mongodb-<wbr/>native query, mongodb-<wbr/>native sort, mongodb-<wbr/>native limit, mongodb-<wbr/>native skip)</span></a></li><li><a href="#md:cancelmongodb-native-query"><span>cancel(mongodb-<wbr/>native query)</span></a></li><li><a href="#md:purge"><span>purge()</span></a></li></ul></li><li><a href="#md:starting-the-job-processor"><span>Starting the job processor</span></a></li><li><ul><li><a href="#md:start"><span>start</span></a></li><li><a href="#md:stop"><span>stop</span></a></li></ul></li><li><a href="#md:multiple-job-processors"><span>Multiple job processors</span></a></li><li><a href="#md:manually-working-with-a-job"><span>Manually working with a job</span></a></li><li><ul><li><a href="#md:repeateveryinterval-options"><span>repeat<wbr/>Every(interval, [options])</span></a></li><li><a href="#md:repeatattime"><span>repeat<wbr/>At(time)</span></a></li><li><a href="#md:scheduletime"><span>schedule(time)</span></a></li><li><a href="#md:prioritypriority"><span>priority(priority)</span></a></li><li><a href="#md:uniqueproperties-options"><span>unique(properties, [options])</span></a></li><li><a href="#md:failreason"><span>fail(reason)</span></a></li><li><a href="#md:runcallback"><span>run(callback)</span></a></li><li><a href="#md:save"><span>save()</span></a></li><li><a href="#md:remove"><span>remove()</span></a></li><li><a href="#md:disable"><span>disable()</span></a></li><li><a href="#md:enable"><span>enable()</span></a></li><li><a href="#md:touch"><span>touch()</span></a></li></ul></li><li><a href="#md:job-queue-events"><span>Job <wbr/>Queue <wbr/>Events</span></a></li><li><a href="#md:frequently-asked-questions"><span>Frequently <wbr/>Asked <wbr/>Questions</span></a></li><li><ul><li><a href="#md:what-is-the-order-in-which-jobs-run"><span>What is the order in which jobs run?</span></a></li><li><a href="#md:what-is-the-difference-between-locklimit-and-maxconcurrency"><span>What is the difference between lock<wbr/>Limit and max<wbr/>Concurrency?</span></a></li><li><a href="#md:sample-project-structure"><span>Sample <wbr/>Project <wbr/>Structure?</span></a></li><li><a href="#md:can-i-donate"><span>Can <wbr/>I <wbr/>Donate?</span></a></li><li><a href="#md:web-interface"><span>Web <wbr/>Interface?</span></a></li><li><a href="#md:mongo-vs-redis"><span>Mongo vs <wbr/>Redis</span></a></li><li><a href="#md:spawning--forking-processes"><span>Spawning / forking processes</span></a></li><li><a href="#md:recovering-lost-mongo-connections-quotauto_reconnectquot"><span>Recovering lost <wbr/>Mongo connections (&quot;auto_<wbr/>reconnect&quot;)</span></a></li></ul></li></ul></li><li><a href="#md:example-project-structure"><span>Example <wbr/>Project <wbr/>Structure</span></a></li><li><a href="#md:debugging-issues"><span>Debugging <wbr/>Issues</span></a></li><li><ul><li><a href="#md:to-turn-on-logging-please-set-your-debug-env-variable-like-so"><span>To turn on logging, please set your DEBUG env variable like so:</span></a></li></ul></li><li><a href="#md:known-issues"><span>Known <wbr/>Issues</span></a></li><li><ul><li><a href="#md:quotmultiple-order-by-items-are-not-supported-please-specify-a-single-order-by-itemquot"><span>&quot;<wbr/>Multiple order-<wbr/>by items are not supported. <wbr/>Please specify a single order-<wbr/>by item.&quot;</span></a></li></ul></li><li><a href="#md:performance"><span>Performance</span></a></li><li><a href="#md:sandboxed-worker---use-child-processes"><span>Sandboxed <wbr/>Worker -<wbr/> use child processes</span></a></li><li><a href="#md:acknowledgements"><span>Acknowledgements</span></a></li><li><a href="#md:license"><span>License</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html" class="current"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-1"></use></svg><span>@mwp/agenda</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base="."><li><a href="classes/Agenda.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-128"></use></svg>Agenda</a></li><li><a href="classes/Job.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-128"></use></svg>Job</a></li><li><a href="interfaces/IAgendaConfig.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-256"></use></svg>IAgendaConfig</a></li><li><a href="interfaces/IDatabaseOptions.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-256"></use></svg>IDatabaseOptions</a></li><li><a href="interfaces/IDbConfig.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-256"></use></svg>IDbConfig</a></li><li><a href="interfaces/IJobDefinition.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-256"></use></svg>IJobDefinition</a></li><li><a href="interfaces/IJobParameters.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-256"></use></svg>IJobParameters</a></li><li><a href="interfaces/IMongoOptions.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-256"></use></svg>IMongoOptions</a></li><li><a href="types/DefinitionProcessor.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-2097152"></use></svg>DefinitionProcessor</a></li><li><a href="types/JobWithId.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-2097152"></use></svg>JobWithId</a></li><li><a href="types/TJobDatefield.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-2097152"></use></svg>TJobDatefield</a></li><li><a href="variables/datefields.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="#icon-32"></use></svg>datefields</a></li></ul></nav></div></div></div><div class="tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><svg style="display: none"><g id="icon-1"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-module)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.162 16V7.24H10.578L11.514 10.072C11.602 10.328 11.674 10.584 11.73 10.84C11.794 11.088 11.842 11.28 11.874 11.416C11.906 11.28 11.954 11.088 12.018 10.84C12.082 10.584 12.154 10.324 12.234 10.06L13.122 7.24H14.538V16H13.482V12.82C13.482 12.468 13.49 12.068 13.506 11.62C13.53 11.172 13.558 10.716 13.59 10.252C13.622 9.78 13.654 9.332 13.686 8.908C13.726 8.476 13.762 8.1 13.794 7.78L12.366 12.16H11.334L9.894 7.78C9.934 8.092 9.97 8.456 10.002 8.872C10.042 9.28 10.078 9.716 10.11 10.18C10.142 10.636 10.166 11.092 10.182 11.548C10.206 12.004 10.218 12.428 10.218 12.82V16H9.162Z" fill="var(--color-text)"></path></g><g id="icon-2"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-module)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.162 16V7.24H10.578L11.514 10.072C11.602 10.328 11.674 10.584 11.73 10.84C11.794 11.088 11.842 11.28 11.874 11.416C11.906 11.28 11.954 11.088 12.018 10.84C12.082 10.584 12.154 10.324 12.234 10.06L13.122 7.24H14.538V16H13.482V12.82C13.482 12.468 13.49 12.068 13.506 11.62C13.53 11.172 13.558 10.716 13.59 10.252C13.622 9.78 13.654 9.332 13.686 8.908C13.726 8.476 13.762 8.1 13.794 7.78L12.366 12.16H11.334L9.894 7.78C9.934 8.092 9.97 8.456 10.002 8.872C10.042 9.28 10.078 9.716 10.11 10.18C10.142 10.636 10.166 11.092 10.182 11.548C10.206 12.004 10.218 12.428 10.218 12.82V16H9.162Z" fill="var(--color-text)"></path></g><g id="icon-4"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-namespace)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.33 16V7.24H10.77L13.446 14.74C13.43 14.54 13.41 14.296 13.386 14.008C13.37 13.712 13.354 13.404 13.338 13.084C13.33 12.756 13.326 12.448 13.326 12.16V7.24H14.37V16H12.93L10.266 8.5C10.282 8.692 10.298 8.936 10.314 9.232C10.33 9.52 10.342 9.828 10.35 10.156C10.366 10.476 10.374 10.784 10.374 11.08V16H9.33Z" fill="var(--color-text)"></path></g><g id="icon-8"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-enum)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.45 16V7.24H14.49V8.224H10.518V10.936H14.07V11.908H10.518V15.016H14.49V16H9.45Z" fill="var(--color-text)"></path></g><g id="icon-16"><rect fill="var(--color-icon-background)" stroke="#FF984D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M9.354 16V7.24H12.174C12.99 7.24 13.638 7.476 14.118 7.948C14.606 8.412 14.85 9.036 14.85 9.82C14.85 10.604 14.606 11.232 14.118 11.704C13.638 12.168 12.99 12.4 12.174 12.4H10.434V16H9.354ZM10.434 11.428H12.174C12.646 11.428 13.022 11.284 13.302 10.996C13.59 10.7 13.734 10.308 13.734 9.82C13.734 9.324 13.59 8.932 13.302 8.644C13.022 8.356 12.646 8.212 12.174 8.212H10.434V11.428Z" fill="var(--color-text)"></path></g><g id="icon-32"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-variable)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M11.106 16L8.85 7.24H9.966L11.454 13.192C11.558 13.608 11.646 13.996 11.718 14.356C11.79 14.708 11.842 14.976 11.874 15.16C11.906 14.976 11.954 14.708 12.018 14.356C12.09 13.996 12.178 13.608 12.282 13.192L13.758 7.24H14.85L12.582 16H11.106Z" fill="var(--color-text)"></path></g><g id="icon-64"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-function)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.39 16V7.24H14.55V8.224H10.446V11.128H14.238V12.112H10.47V16H9.39Z" fill="var(--color-text)"></path></g><g id="icon-128"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-class)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M11.898 16.1201C11.098 16.1201 10.466 15.8961 10.002 15.4481C9.53803 15.0001 9.30603 14.3841 9.30603 13.6001V9.64012C9.30603 8.85612 9.53803 8.24012 10.002 7.79212C10.466 7.34412 11.098 7.12012 11.898 7.12012C12.682 7.12012 13.306 7.34812 13.77 7.80412C14.234 8.25212 14.466 8.86412 14.466 9.64012H13.386C13.386 9.14412 13.254 8.76412 12.99 8.50012C12.734 8.22812 12.37 8.09212 11.898 8.09212C11.426 8.09212 11.054 8.22412 10.782 8.48812C10.518 8.75212 10.386 9.13212 10.386 9.62812V13.6001C10.386 14.0961 10.518 14.4801 10.782 14.7521C11.054 15.0161 11.426 15.1481 11.898 15.1481C12.37 15.1481 12.734 15.0161 12.99 14.7521C13.254 14.4801 13.386 14.0961 13.386 13.6001H14.466C14.466 14.3761 14.234 14.9921 13.77 15.4481C13.306 15.8961 12.682 16.1201 11.898 16.1201Z" fill="var(--color-text)"></path></g><g id="icon-256"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-interface)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.51 16V15.016H11.298V8.224H9.51V7.24H14.19V8.224H12.402V15.016H14.19V16H9.51Z" fill="var(--color-text)"></path></g><g id="icon-512"><rect fill="var(--color-icon-background)" stroke="#4D7FFF" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M11.898 16.1201C11.098 16.1201 10.466 15.8961 10.002 15.4481C9.53803 15.0001 9.30603 14.3841 9.30603 13.6001V9.64012C9.30603 8.85612 9.53803 8.24012 10.002 7.79212C10.466 7.34412 11.098 7.12012 11.898 7.12012C12.682 7.12012 13.306 7.34812 13.77 7.80412C14.234 8.25212 14.466 8.86412 14.466 9.64012H13.386C13.386 9.14412 13.254 8.76412 12.99 8.50012C12.734 8.22812 12.37 8.09212 11.898 8.09212C11.426 8.09212 11.054 8.22412 10.782 8.48812C10.518 8.75212 10.386 9.13212 10.386 9.62812V13.6001C10.386 14.0961 10.518 14.4801 10.782 14.7521C11.054 15.0161 11.426 15.1481 11.898 15.1481C12.37 15.1481 12.734 15.0161 12.99 14.7521C13.254 14.4801 13.386 14.0961 13.386 13.6001H14.466C14.466 14.3761 14.234 14.9921 13.77 15.4481C13.306 15.8961 12.682 16.1201 11.898 16.1201Z" fill="var(--color-text)"></path></g><g id="icon-1024"><rect fill="var(--color-icon-background)" stroke="#FF984D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M9.354 16V7.24H12.174C12.99 7.24 13.638 7.476 14.118 7.948C14.606 8.412 14.85 9.036 14.85 9.82C14.85 10.604 14.606 11.232 14.118 11.704C13.638 12.168 12.99 12.4 12.174 12.4H10.434V16H9.354ZM10.434 11.428H12.174C12.646 11.428 13.022 11.284 13.302 10.996C13.59 10.7 13.734 10.308 13.734 9.82C13.734 9.324 13.59 8.932 13.302 8.644C13.022 8.356 12.646 8.212 12.174 8.212H10.434V11.428Z" fill="var(--color-text)"></path></g><g id="icon-2048"><rect fill="var(--color-icon-background)" stroke="#FF4DB8" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M9.162 16V7.24H10.578L11.514 10.072C11.602 10.328 11.674 10.584 11.73 10.84C11.794 11.088 11.842 11.28 11.874 11.416C11.906 11.28 11.954 11.088 12.018 10.84C12.082 10.584 12.154 10.324 12.234 10.06L13.122 7.24H14.538V16H13.482V12.82C13.482 12.468 13.49 12.068 13.506 11.62C13.53 11.172 13.558 10.716 13.59 10.252C13.622 9.78 13.654 9.332 13.686 8.908C13.726 8.476 13.762 8.1 13.794 7.78L12.366 12.16H11.334L9.894 7.78C9.934 8.092 9.97 8.456 10.002 8.872C10.042 9.28 10.078 9.716 10.11 10.18C10.142 10.636 10.166 11.092 10.182 11.548C10.206 12.004 10.218 12.428 10.218 12.82V16H9.162Z" fill="var(--color-text)"></path></g><g id="icon-4096"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-function)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M9.39 16V7.24H14.55V8.224H10.446V11.128H14.238V12.112H10.47V16H9.39Z" fill="var(--color-text)"></path></g><g id="icon-8192"><rect fill="var(--color-icon-background)" stroke="#FF984D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M9.354 16V7.24H12.174C12.99 7.24 13.638 7.476 14.118 7.948C14.606 8.412 14.85 9.036 14.85 9.82C14.85 10.604 14.606 11.232 14.118 11.704C13.638 12.168 12.99 12.4 12.174 12.4H10.434V16H9.354ZM10.434 11.428H12.174C12.646 11.428 13.022 11.284 13.302 10.996C13.59 10.7 13.734 10.308 13.734 9.82C13.734 9.324 13.59 8.932 13.302 8.644C13.022 8.356 12.646 8.212 12.174 8.212H10.434V11.428Z" fill="var(--color-text)"></path></g><g id="icon-16384"><rect fill="var(--color-icon-background)" stroke="#4D7FFF" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M11.898 16.1201C11.098 16.1201 10.466 15.8961 10.002 15.4481C9.53803 15.0001 9.30603 14.3841 9.30603 13.6001V9.64012C9.30603 8.85612 9.53803 8.24012 10.002 7.79212C10.466 7.34412 11.098 7.12012 11.898 7.12012C12.682 7.12012 13.306 7.34812 13.77 7.80412C14.234 8.25212 14.466 8.86412 14.466 9.64012H13.386C13.386 9.14412 13.254 8.76412 12.99 8.50012C12.734 8.22812 12.37 8.09212 11.898 8.09212C11.426 8.09212 11.054 8.22412 10.782 8.48812C10.518 8.75212 10.386 9.13212 10.386 9.62812V13.6001C10.386 14.0961 10.518 14.4801 10.782 14.7521C11.054 15.0161 11.426 15.1481 11.898 15.1481C12.37 15.1481 12.734 15.0161 12.99 14.7521C13.254 14.4801 13.386 14.0961 13.386 13.6001H14.466C14.466 14.3761 14.234 14.9921 13.77 15.4481C13.306 15.8961 12.682 16.1201 11.898 16.1201Z" fill="var(--color-text)"></path></g><g id="icon-32768"><rect fill="var(--color-icon-background)" stroke="#FF984D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M9.354 16V7.24H12.174C12.99 7.24 13.638 7.476 14.118 7.948C14.606 8.412 14.85 9.036 14.85 9.82C14.85 10.604 14.606 11.232 14.118 11.704C13.638 12.168 12.99 12.4 12.174 12.4H10.434V16H9.354ZM10.434 11.428H12.174C12.646 11.428 13.022 11.284 13.302 10.996C13.59 10.7 13.734 10.308 13.734 9.82C13.734 9.324 13.59 8.932 13.302 8.644C13.022 8.356 12.646 8.212 12.174 8.212H10.434V11.428Z" fill="var(--color-text)"></path></g><g id="icon-65536"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-type-alias)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M11.31 16V8.224H8.91V7.24H14.79V8.224H12.39V16H11.31Z" fill="var(--color-text)"></path></g><g id="icon-131072"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-type-alias)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M11.31 16V8.224H8.91V7.24H14.79V8.224H12.39V16H11.31Z" fill="var(--color-text)"></path></g><g id="icon-262144"><rect fill="var(--color-icon-background)" stroke="#FF4D4D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M8.85 16L11.13 7.24H12.582L14.85 16H13.758L13.182 13.672H10.53L9.954 16H8.85ZM10.746 12.76H12.954L12.282 10.06C12.154 9.548 12.054 9.12 11.982 8.776C11.91 8.432 11.866 8.208 11.85 8.104C11.834 8.208 11.79 8.432 11.718 8.776C11.646 9.12 11.546 9.544 11.418 10.048L10.746 12.76Z" fill="var(--color-text)"></path></g><g id="icon-524288"><rect fill="var(--color-icon-background)" stroke="#FF4D4D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M8.85 16L11.13 7.24H12.582L14.85 16H13.758L13.182 13.672H10.53L9.954 16H8.85ZM10.746 12.76H12.954L12.282 10.06C12.154 9.548 12.054 9.12 11.982 8.776C11.91 8.432 11.866 8.208 11.85 8.104C11.834 8.208 11.79 8.432 11.718 8.776C11.646 9.12 11.546 9.544 11.418 10.048L10.746 12.76Z" fill="var(--color-text)"></path></g><g id="icon-1048576"><rect fill="var(--color-icon-background)" stroke="#FF4D4D" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M8.85 16L11.13 7.24H12.582L14.85 16H13.758L13.182 13.672H10.53L9.954 16H8.85ZM10.746 12.76H12.954L12.282 10.06C12.154 9.548 12.054 9.12 11.982 8.776C11.91 8.432 11.866 8.208 11.85 8.104C11.834 8.208 11.79 8.432 11.718 8.776C11.646 9.12 11.546 9.544 11.418 10.048L10.746 12.76Z" fill="var(--color-text)"></path></g><g id="icon-2097152"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-type-alias)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6"></rect><path d="M11.31 16V8.224H8.91V7.24H14.79V8.224H12.39V16H11.31Z" fill="var(--color-text)"></path></g><g id="icon-4194304"><rect fill="var(--color-icon-background)" stroke="#FF4D82" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="12"></rect><path d="M10.354 17V8.24H13.066C13.586 8.24 14.042 8.348 14.434 8.564C14.826 8.772 15.13 9.064 15.346 9.44C15.562 9.816 15.67 10.256 15.67 10.76C15.67 11.352 15.514 11.86 15.202 12.284C14.898 12.708 14.482 13 13.954 13.16L15.79 17H14.518L12.838 13.28H11.434V17H10.354ZM11.434 12.308H13.066C13.514 12.308 13.874 12.168 14.146 11.888C14.418 11.6 14.554 11.224 14.554 10.76C14.554 10.288 14.418 9.912 14.146 9.632C13.874 9.352 13.514 9.212 13.066 9.212H11.434V12.308Z" fill="var(--color-text)"></path></g><g id="icon-chevronDown"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></g><g id="icon-chevronSmall"><path d="M1.5 5.50969L8 11.6609L14.5 5.50969L12.5466 3.66086L8 7.96494L3.45341 3.66086L1.5 5.50969Z" fill="var(--color-text)"></path></g><g id="icon-menu"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></g><g id="icon-search"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></g><g id="icon-anchor"><g stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5"></path><path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5"></path></g></g></svg></body></html>